<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTM Test</title>
</head>
<body>
    <h1>UTM Test Page</h1>
    <p>This page tests the UTM capture system.</p>
    
    <div>
        <h3>Test URLs:</h3>
        <ul>
            <li><a href="?utm_source=google&utm_medium=cpc&utm_campaign=summer_sale">Test with UTMs</a></li>
            <li><a href="?utm_source=facebook&utm_medium=social&utm_campaign=lead_gen">Facebook Campaign</a></li>
            <li><a href="#">No UTMs</a></li>
        </ul>
    </div>

    <div>
        <h3>Current URL UTMs:</h3>
        <div id="current-utms"></div>
    </div>

    <div>
        <h3>Stored UTMs (localStorage):</h3>
        <div id="stored-utms"></div>
    </div>

    <div>
        <button onclick="clearUtms()">Clear Stored UTMs</button>
        <button onclick="showUtms()">Refresh Display</button>
    </div>

    <script>
        const UTM_STORAGE_KEY = "app_utms_v1";
        const UTM_KEYS = ["utm_source", "utm_medium", "utm_campaign", "utm_term", "utm_content"];

        function readUtmsFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const utms = {};

            let hasAny = false;
            for (const key of UTM_KEYS) {
                const val = params.get(key);
                utms[key] = val ? val : null;
                if (val) hasAny = true;
            }

            return { utms, hasAny };
        }

        function initUtmCaptureOnce() {
            try {
                const already = localStorage.getItem(UTM_STORAGE_KEY);
                if (already) {
                    console.log('UTMs already stored, not overwriting');
                    return;
                }

                const { utms, hasAny } = readUtmsFromUrl();
                if (!hasAny) {
                    console.log('No UTMs in URL to store');
                    return;
                }

                localStorage.setItem(UTM_STORAGE_KEY, JSON.stringify(utms));
                console.log('UTMs stored:', utms);
            } catch (e) {
                console.error('Error storing UTMs:', e);
            }
        }

        function getStoredUtms() {
            try {
                const raw = localStorage.getItem(UTM_STORAGE_KEY);
                const parsed = raw ? JSON.parse(raw) : null;

                const out = {};
                for (const key of UTM_KEYS) {
                    out[key] = parsed?.[key] ?? null;
                }
                return out;
            } catch (e) {
                console.error('Error reading stored UTMs:', e);
                return Object.fromEntries(UTM_KEYS.map(k => [k, null]));
            }
        }

        function clearUtms() {
            localStorage.removeItem(UTM_STORAGE_KEY);
            showUtms();
        }

        function showUtms() {
            // Show current URL UTMs
            const currentUtms = readUtmsFromUrl();
            document.getElementById('current-utms').innerHTML = 
                '<pre>' + JSON.stringify(currentUtms.utms, null, 2) + '</pre>';

            // Show stored UTMs
            const storedUtms = getStoredUtms();
            document.getElementById('stored-utms').innerHTML = 
                '<pre>' + JSON.stringify(storedUtms, null, 2) + '</pre>';
        }

        // Initialize on page load
        initUtmCaptureOnce();
        showUtms();
    </script>
</body>
</html>
